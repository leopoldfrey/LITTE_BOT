<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" href="style.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <title>Litte_Bot_Admin</title>
</head>
<body>
  <div id='topbar'>LITTE_BOT_ADMIN
    <label class="switch">
        <input type="checkbox" name="phone" id="phone">
        <span class="slider round"></span>
      </label>
    <br/>
    <!-- <input type="number" id="max_interactions" name="max_interactions" min="1" max="100" disabled>
    <label for="max_interactions">Nombre maximum d'interactions</label><br/>
    <input type="number" id="max_section" name="max_section" min="10" max="360" disabled>
    <label for="max_section">Duree maximum d'une section (en secondes)</label><br/> -->
    <h5>Introduction</h5>
    <input type="number" id="max_intro" name="max_intro" min="1" max="100">
    <label for="max_intro">Nombre maximum d'interactions</label><br/>
    <input type="number" id="max_intro_s" name="max_intro_s" min="10" max="360">
    <label for="max_intro_s">Durée maximum d'interaction (en secondes)</label><br/>
    <h5>Seduction</h5>
    <input type="number" id="max_seduction" name="max_seduction" min="1" max="100">
    <label for="max_seduction">Nombre maximum d'interactions</label><br/>
    <input type="number" id="max_seduction_s" name="max_seduction_s" min="10" max="360">
    <label for="max_seduction_s">Durée maximum d'interaction (en secondes)</label><br/>
    <h5>Provocation</h5>
    <input type="number" id="max_provocation" name="max_provocation" min="1" max="100">
    <label for="max_provocation">Nombre maximum d'interactions</label><br/>
    <input type="number" id="max_provocation_s" name="max_provocation_s" min="10" max="360">
    <label for="max_provocation_s">Durée maximum d'interaction (en secondes)</label><br/>
    <h5>Fuite</h5>
    <input type="number" id="max_fuite" name="max_fuite" min="1" max="100">
    <label for="max_fuite">Nombre maximum d'interactions</label><br/>
    <input type="number" id="max_fuite_s" name="max_fuite_s" min="10" max="360">
    <label for="max_fuite_s">Durée maximum d'interaction (en secondes)</label><br/>
    <h5>General</h5>
    <input type="number" id="max_silence" name="max_silence" min="1" max="120">
    <label for="max_silence">Silence maximum avant relance (en secondes)</label><br/>
    <input type="number" id="max_inter_relance" name="max_inter_relance" min="3" max="360">
    <label for="max_inter_relance">Nombres d'interactions avant relance</label><br/>
    <button class="but2" id="save_params" onclick='saveConfig()'>Sauvegarder les parametres</button>
    <button class="but2" id="reload" onclick='reloadBrain()'>Recharger les donnees</button>
  </div>
  <div id='speech'>
  </div>
  <div id='info'>
    <div id="status1" onclick='stepUp()'></div>
    <div id="status2" onclick='pause()'>Off</div>
    <div id="timer" onclick='reset()' style='display: unset'>0:00</div>
  </div>
  <script>
  // INIT VARS
  var timer = null;
  var name = "user";
  var $silent = false;
  var $sp = $('#speech');
  var p;

  $(".speech_you").attr('data-content', name+" : ")

  $stat1 = $("#status1");
  $stat2 = $("#status2");
  $timer = $("#timer");

  // INIT WEBSOCKET
  let socket = new WebSocket("ws://localhost:9001");

  socket.onopen = function(e) {
    console.log("[open] Connection established");
    socket.send(JSON.stringify({'command':'connect'}));
    socket.send(JSON.stringify({'command':'getConfig'}));
  };

  socket.onmessage = function(event) {
    // console.log(`[message] Data received from server: ${event.data}`);
    data = JSON.parse(event.data);
    if(data.command == "on") {
      console.log("ON", data.value);
      $("#phone").prop("checked", data.value);
    } else if(data.command == "message") {
      console.log("[ws]", data);
    } else if(data.command == "bot" || data.command == "_bot") {
      console.log("BOT", data.value);
      p = $('<p class="speech_bot"></p>');
      $(p).text(data.value);
      $sp.append(p);
      $(p).get(0).scrollIntoView();
    } else if(data.command == "_user") {
      console.log("USER", data.value);
      p = $('<p class="speech_you"></p>');
      $(p).text(data.value);
      $sp.append(p);
      $(".speech_you").attr('data-content', name+" : ")
      $(p).get(0).scrollIntoView();
    } else if(data.command == "clear") {
      $sp.empty();
    } else if(data.command == "timers") {
      $timer.html("Interactions : "+data.interactions+"<br/>Global : "+convertTime(data.global)+"<br/>Section : "+convertTime(data.section)+"<br/>Interaction : "+convertTime(data.current));
    } else if(data.command == "step") {
      switch (data.value) {
        case 0:
          $stat1.text("0. Off");
          $timer.show();
          break;
        case 1:
          $stat1.text("1. Introduction");
          $timer.show();
          break;
        case 2:
          $stat1.text("2. Seduction");
          $timer.show();
          break;
        case 3:
          $stat1.text("3. Provocation");
          $timer.show();
          break;
        case 4:
          $stat1.text("4. Fuite");
          $timer.show();
          break;
        case 5:
          $stat1.text("5. Epilogue");
          $timer.show();
          break;
        default:
          $stat1.text("0. Off");
          $timer.show();
          break;
      }
    } else if(data.command == "username") {
      if(data.value != "")
        name = data.value;
        $(".speech_you").attr('data-content', name+" : ");
    } else if(data.command == "silent") {
      $silent = data.value;
      if($silent) {
        $stat2.text('Pause');
        $stat2.removeClass('ready');
        $stat2.addClass('pause');
      } else {
        $stat2.text('Ready');
        $stat2.removeClass('pause');
        $stat2.addClass('ready');
      }
    } else if(data.command == "params") {
      // $("#max_interactions").val(data.max_interactions);
      // $("#max_section").val(data.max_section);
      $("#max_intro").val(data.max_intro);
      $("#max_seduction").val(data.max_seduction);
      $("#max_provocation").val(data.max_provocation);
      $("#max_fuite").val(data.max_fuite);
      $("#max_intro_s").val(data.max_intro_s);
      $("#max_seduction_s").val(data.max_seduction_s);
      $("#max_provocation_s").val(data.max_provocation_s);
      $("#max_fuite_s").val(data.max_fuite_s);
      $("#max_silence").val(data.max_silence);
      $("#max_inter_relance").val(data.max_inter_relance);
    } else {
      console.log("[ws]", data);
    }
  };

  socket.onclose = function(event) {
    console.log('[close] Connection closed');
  };

  socket.onerror = function(error) {
    console.log(`[error] ${error.message}`);
  };

  function pause() {
    socket.send(JSON.stringify({'command':'pause'}));
  }

  function reset() {
    socket.send(JSON.stringify({'command':'reset'}));
  }

  function stop() {
    socket.send(JSON.stringify({'command':'stop'}));
  }

  function stepUp() {
    socket.send(JSON.stringify({'command':'stepUp'}));
  }

  $stat2.text('Pause');
  $stat2.removeClass('error');
  $stat2.removeClass('ready');
  $stat2.addClass('pause');

  function convertTime(t) {
    s = Math.floor(t);
    ss = s % 60;
    m = Math.floor(s / 60);
    // console.log(m, ss);
    return zeroPad(m, 2)+":"+zeroPad(ss, 2);
  }

  function zeroPad(num, places) {
    var zero = places - num.toString().length + 1;
    return Array(+(zero > 0 && zero)).join("0") + num;
  }

  function saveConfig() {
    socket.send(JSON.stringify({
        'command':          'saveConfig',
        'max_intro':        $("#max_intro").val(),
        'max_seduction':    $("#max_seduction").val(),
        'max_provocation':  $("#max_provocation").val(),
        'max_fuite':        $("#max_fuite").val(),
        'max_intro_s':        $("#max_intro_s").val(),
        'max_seduction_s':    $("#max_seduction_s").val(),
        'max_provocation_s':  $("#max_provocation_s").val(),
        'max_fuite_s':        $("#max_fuite_s").val(),
        'max_silence':      $("#max_silence").val(),
        'max_inter_relance':$("#max_inter_relance").val()
        // 'max_interactions': $("#max_interactions").val(),
        // 'max_section':      $("#max_section").val()
      }));
  }

  function reloadBrain() {
    socket.send(JSON.stringify({'command':'reload'}));
  }

  $("#phone").change(function () {
      // console.log($("#phone").prop('checked'));
      $silent = !$("#phone").prop('checked');
      if($silent) {
        $stat2.text('Pause');
        $stat2.removeClass('ready');
        $stat2.addClass('pause');
      } else {
        $stat2.text('Ready');
        $stat2.removeClass('pause');
        $stat2.addClass('ready');
      }
      socket.send(JSON.stringify({'command':'phone', 'phone':$("#phone").prop('checked') ? 1 : 0}));
   });

  </script>
</body>
</html>
